name: Deploy Cloudflare Workers

on:
  push:
    branches:
      - main
    paths:
      - 'workers/**'
      - '.github/workflows/deploy-workers.yml'
  workflow_dispatch: # Allow manual triggering

jobs:
  # Discover all worker directories
  find-workers:
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.get-workers.outputs.workers }}
      worker-count: ${{ steps.get-workers.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find all workers
        id: get-workers
        run: |
          # Find all directories in workers/ (excluding hidden files)
          workers=$(find workers -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          count=$(echo "$workers" | jq 'length')

          echo "workers=$workers" >> $GITHUB_OUTPUT
          echo "count=$count" >> $GITHUB_OUTPUT

          echo "üì¶ Found $count worker(s) to deploy:"
          echo "$workers" | jq -r '.[]' | sed 's/^/  - /'

  # Deploy all discovered workers
  deploy:
    needs: find-workers
    runs-on: ubuntu-latest
    if: needs.find-workers.outputs.worker-count > 0

    strategy:
      matrix:
        worker: ${{ fromJson(needs.find-workers.outputs.workers) }}
      fail-fast: false  # Continue deploying other workers even if one fails

    name: Deploy ${{ matrix.worker }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Check if secrets are needed
        id: check-secrets
        run: |
          # Check if worker code references ANTHROPIC_API_KEY
          if grep -q "ANTHROPIC_API_KEY" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-anthropic-key=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses ANTHROPIC_API_KEY - will configure secret"
          else
            echo "needs-anthropic-key=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use ANTHROPIC_API_KEY - skipping secret configuration"
          fi

          # Check if worker code references ELEVENLABS_API_KEY
          if grep -q "ELEVENLABS_API_KEY" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-elevenlabs-key=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses ELEVENLABS_API_KEY - will configure secret"
          else
            echo "needs-elevenlabs-key=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use ELEVENLABS_API_KEY - skipping secret configuration"
          fi

          # Check if worker code references AUTH_TOKEN
          if grep -q "AUTH_TOKEN" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-auth-token=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses AUTH_TOKEN - will configure secret"
          else
            echo "needs-auth-token=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use AUTH_TOKEN - skipping secret configuration"
          fi

          # Check if worker code references NTFY_TOPIC
          if grep -q "NTFY_TOPIC" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-ntfy-topic=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses NTFY_TOPIC - will configure secret"
          else
            echo "needs-ntfy-topic=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use NTFY_TOPIC - skipping secret configuration"
          fi

          # Check if worker code references GOOGLE_SERVICE_ACCOUNT_KEY
          if grep -q "GOOGLE_SERVICE_ACCOUNT_KEY" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-google-sa-key=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses GOOGLE_SERVICE_ACCOUNT_KEY - will configure secret"
          else
            echo "needs-google-sa-key=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use GOOGLE_SERVICE_ACCOUNT_KEY - skipping secret configuration"
          fi

          # Check if worker code references SPREADSHEET_ID
          if grep -q "SPREADSHEET_ID" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-spreadsheet-id=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses SPREADSHEET_ID - will configure secret"
          else
            echo "needs-spreadsheet-id=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use SPREADSHEET_ID - skipping secret configuration"
          fi

          # Check if worker code references APPS_SCRIPT_URL
          if grep -q "APPS_SCRIPT_URL" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-apps-script-url=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses APPS_SCRIPT_URL - will configure secret"
          else
            echo "needs-apps-script-url=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use APPS_SCRIPT_URL - skipping secret configuration"
          fi

          # Check if worker code references GEMINI_API_KEY
          if grep -q "GEMINI_API_KEY" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-gemini-key=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses GEMINI_API_KEY - will configure secret"
          else
            echo "needs-gemini-key=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use GEMINI_API_KEY - skipping secret configuration"
          fi

      - name: Set ANTHROPIC_API_KEY secret
        if: steps.check-secrets.outputs.needs-anthropic-key == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | wrangler secret put ANTHROPIC_API_KEY

      - name: Set ELEVENLABS_API_KEY secret
        if: steps.check-secrets.outputs.needs-elevenlabs-key == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.ELEVENLABS_API_KEY }}" | wrangler secret put ELEVENLABS_API_KEY

      - name: Set AUTH_TOKEN secret
        if: steps.check-secrets.outputs.needs-auth-token == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.AUTH_TOKEN }}" | wrangler secret put AUTH_TOKEN

      - name: Set NTFY_TOPIC secret
        if: steps.check-secrets.outputs.needs-ntfy-topic == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.NTFY_TOPIC }}" | wrangler secret put NTFY_TOPIC

      - name: Set GOOGLE_SERVICE_ACCOUNT_KEY secret
        if: steps.check-secrets.outputs.needs-google-sa-key == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}' | wrangler secret put GOOGLE_SERVICE_ACCOUNT_KEY

      - name: Set SPREADSHEET_ID secret
        if: steps.check-secrets.outputs.needs-spreadsheet-id == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.SPREADSHEET_ID }}" | wrangler secret put SPREADSHEET_ID

      - name: Set APPS_SCRIPT_URL secret
        if: steps.check-secrets.outputs.needs-apps-script-url == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.APPS_SCRIPT_URL }}" | wrangler secret put APPS_SCRIPT_URL

      - name: Set GEMINI_API_KEY secret
        if: steps.check-secrets.outputs.needs-gemini-key == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.GEMINI_API_KEY }}" | wrangler secret put GEMINI_API_KEY

      - name: Deploy worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          wrangler deploy

      - name: Deployment summary
        run: |
          echo "‚úÖ Worker '${{ matrix.worker }}' deployed successfully!"
          echo "üåê Worker URL: https://${{ matrix.worker }}.zammel.workers.dev"

  # Summary of all deployments
  summary:
    needs: [find-workers, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment summary
        run: |
          echo "üéâ Deployment complete!"
          echo "üì¶ Total workers deployed: ${{ needs.find-workers.outputs.worker-count }}"
          echo ""
          echo "Workers:"
          echo '${{ needs.find-workers.outputs.workers }}' | jq -r '.[] | "  ‚úì https://\(.).zammel.workers.dev"'
