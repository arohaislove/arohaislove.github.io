# Perspective Engine Reddit Bot

A Cloudflare Worker that monitors a Reddit post about the [Perspective Engine](https://arohaislove.github.io/perspective-engine/) and replies to comments with lighthearted, contemplative responses generated by Claude AI.

The bot embodies the spirit of the Perspective Engine — a memento mori visualization that helps people appreciate the finite nature of time.

## Features

- **Automated monitoring**: Runs every 10 minutes via cron trigger
- **AI-powered responses**: Uses Claude API to generate thoughtful, contextual replies
- **Rate limiting**: Maximum 3 replies per run to stay natural
- **Smart filtering**: Only replies to recent, top-level comments
- **Deduplication**: Tracks replied comments using Cloudflare KV
- **Random delays**: 30-120 second delays between replies to appear human
- **Safety checks**: Skips sensitive topics (mental health, legal, political)

## Architecture

```
┌─────────────────┐
│  Cron Trigger   │  Every 10 minutes
│  (Cloudflare)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Perspective    │
│      Bot        │
│   (Worker)      │
└────────┬────────┘
         │
         ├──► Reddit API (fetch comments, post replies)
         ├──► Claude API (generate responses)
         └──► Cloudflare KV (track replied comments)
```

## File Structure

```
perspective-bot/
├── index.js        # Main worker entry point & cron handler
├── reddit.js       # Reddit API integration (OAuth, comments, replies)
├── claude.js       # Claude API integration (response generation)
├── config.js       # Constants, prompts, configuration
├── wrangler.toml   # Cloudflare Worker configuration
└── README.md       # This file
```

## Setup Instructions

### Prerequisites

1. **Cloudflare Account** (free tier works fine)
2. **Reddit Account** for the bot
3. **Reddit App** (OAuth credentials)
4. **Anthropic API Key**
5. **Wrangler CLI** installed globally

### Step 1: Create Reddit App

1. Go to https://www.reddit.com/prefs/apps
2. Click "create another app"
3. Select "script"
4. Fill in:
   - **name**: perspective-bot
   - **description**: Bot for Perspective Engine discussions
   - **redirect uri**: http://localhost
5. Save the **client ID** (under the app name) and **secret**

### Step 2: Create KV Namespace

The KV namespace is used to track which comments have been replied to.

**Option A: Via GitHub Actions (Automatic)**

When you merge this PR to main, GitHub Actions will automatically:
- Detect the KV namespace requirement in `wrangler.toml`
- Create the namespace if it doesn't exist
- Update the configuration
- Deploy the worker

**Option B: Manual Creation (for testing)**

If you want to test locally first:

```bash
# Install wrangler if not already installed
npm install -g wrangler

# Login to Cloudflare
wrangler login

# Create the KV namespace
wrangler kv namespace create REPLIED_COMMENTS --preview false

# This will output something like:
# { binding = "REPLIED_COMMENTS", id = "abc123..." }

# Copy the ID and update wrangler.toml
# Replace YOUR_KV_NAMESPACE_ID with the actual ID
```

### Step 3: Configure Secrets

Secrets are sensitive values that should never be committed to the repository.

**Option A: Via GitHub (Recommended for Production)**

The repository owner should add these as GitHub repository secrets (Settings → Secrets and variables → Actions):

- `REDDIT_CLIENT_ID` - Reddit app client ID
- `REDDIT_CLIENT_SECRET` - Reddit app secret
- `REDDIT_USERNAME` - Bot's Reddit username
- `REDDIT_PASSWORD` - Bot's Reddit password
- `ANTHROPIC_API_KEY` - Already configured
- `REDDIT_POST_ID` - The Reddit post ID to monitor (add when ready to go live)

**Option B: Via Wrangler CLI (for local testing)**

```bash
cd workers/perspective-bot

wrangler secret put REDDIT_CLIENT_ID
# Enter the value when prompted

wrangler secret put REDDIT_CLIENT_SECRET
wrangler secret put REDDIT_USERNAME
wrangler secret put REDDIT_PASSWORD
wrangler secret put ANTHROPIC_API_KEY

# DO NOT set REDDIT_POST_ID yet - wait until you're ready to go live
```

### Step 4: Deploy the Worker

**Option A: Via GitHub Actions (Production)**

Simply merge the PR to `main`. GitHub Actions will automatically deploy the worker to:
```
https://perspective-bot.zammel.workers.dev
```

**Option B: Manual Deployment (Testing)**

```bash
cd workers/perspective-bot
wrangler deploy
```

### Step 5: Test Before Going Live

Before setting `REDDIT_POST_ID`, test the worker manually:

```bash
# Trigger the worker manually (simulates cron)
curl https://perspective-bot.zammel.workers.dev/test
```

Check the logs:
```bash
wrangler tail perspective-bot
```

You should see:
```
⚠️  REDDIT_POST_ID not configured. Bot is in standby mode.
```

This confirms the worker is running but not yet active.

### Step 6: Go Live

When you're ready to start monitoring a Reddit post:

1. **Create or identify the Reddit post** you want to monitor
2. **Extract the post ID** from the URL:
   ```
   https://www.reddit.com/r/subreddit/comments/abc123/title/
                                                    ^^^^^^
                                                    This is the post ID
   ```
3. **Set the secret**:
   ```bash
   wrangler secret put REDDIT_POST_ID
   # Enter: abc123
   ```

The bot will start monitoring on the next cron run (within 10 minutes).

## Configuration

### Rate Limits

Edit `config.js` to adjust:

```javascript
export const MAX_REPLIES_PER_RUN = 3;        // Max replies per 10-min run
export const MIN_DELAY_SECONDS = 30;         // Min delay between replies
export const MAX_DELAY_SECONDS = 120;        // Max delay between replies
export const MAX_COMMENT_AGE_HOURS = 24;     // Only reply to recent comments
```

### Claude System Prompt

The bot's personality is defined in `config.js`:

```javascript
export const CLAUDE_SYSTEM_PROMPT = `...`;
```

You can modify this to adjust the tone and behavior.

### Cron Schedule

Edit `wrangler.toml` to change how often the bot runs:

```toml
[triggers]
crons = ["*/10 * * * *"]  # Every 10 minutes
```

Examples:
- `*/5 * * * *` - Every 5 minutes
- `*/30 * * * *` - Every 30 minutes
- `0 * * * *` - Every hour

## How It Works

### Flow

1. **Cron triggers** every 10 minutes
2. **Check configuration**: Exit if `REDDIT_POST_ID` not set
3. **Authenticate with Reddit**: Get OAuth token
4. **Fetch comments**: Get up to 50 newest comments
5. **Filter comments**:
   - Must be top-level (direct reply to post)
   - Must be less than 24 hours old
   - Must not be deleted/removed
   - Must not be from the bot itself
   - Must not have been replied to already
6. **For each valid comment** (up to 3):
   - **Generate response** using Claude API
   - If Claude returns `[SKIP]`, mark as skipped and continue
   - **Schedule reply** with random delay (30-120s)
   - **Post reply** to Reddit
   - **Mark as replied** in KV storage
7. **Log summary** and exit

### Safety Features

The bot includes multiple safety mechanisms:

1. **Claude discretion**: Claude can choose not to respond by returning `[SKIP]`
2. **Topic filtering**: Claude is instructed to skip:
   - Legal issues or advice
   - Mental health crises or self-harm
   - Political or religious discussions
   - Spam, hostility, or trolling
   - Questions better answered by the creator
3. **Rate limiting**: Max 3 replies per run, random delays
4. **Age filtering**: Only replies to comments less than 24 hours old
5. **Deduplication**: Never replies to the same comment twice
6. **Self-awareness**: Never replies to its own comments

## Monitoring

### View Logs

```bash
wrangler tail perspective-bot
```

### Check KV Storage

```bash
# List all keys
wrangler kv key list --namespace-id=YOUR_NAMESPACE_ID

# Get a specific key
wrangler kv key get "replied:abc123" --namespace-id=YOUR_NAMESPACE_ID
```

### Disable the Bot

To temporarily stop the bot without deleting it:

```bash
wrangler secret put REDDIT_POST_ID
# Enter: (leave empty or press Ctrl+C)
```

Or delete the secret:
```bash
wrangler secret delete REDDIT_POST_ID
```

The bot will enter standby mode and stop processing comments.

## Troubleshooting

### Bot isn't posting replies

1. **Check logs**: `wrangler tail perspective-bot`
2. **Verify secrets**: All required secrets are set
3. **Check Reddit rate limits**: Bot may have been rate limited
4. **Check comment age**: Only replies to comments < 24 hours old
5. **Check Claude responses**: Claude may be choosing to skip comments

### Reddit API errors

- **401 Unauthorized**: Check Reddit credentials and app setup
- **429 Rate Limited**: Bot will automatically stop and retry on next cron
- **403 Forbidden**: Check Reddit app permissions

### Claude API errors

- **401 Unauthorized**: Check `ANTHROPIC_API_KEY`
- **Rate limited**: Consider reducing `MAX_REPLIES_PER_RUN`

### KV errors

- **Namespace not found**: Check the namespace ID in `wrangler.toml`
- **Permission denied**: Check Cloudflare account permissions

## Cost Estimate

### Cloudflare Workers

- **Free tier**: 100,000 requests/day
- **This bot**: ~144 requests/day (6 per hour × 24 hours)
- **Cost**: Free

### Cloudflare KV

- **Free tier**: 100,000 reads/day, 1,000 writes/day
- **This bot**: ~432 reads/day, ~9 writes/day (if 3 replies per run)
- **Cost**: Free

### Claude API

- **Claude 3.5 Sonnet**: ~$3 per million input tokens, ~$15 per million output tokens
- **Estimated usage**: ~300 tokens per comment × 3 replies per run × 144 runs per day
- **Daily cost**: ~$0.01-0.02
- **Monthly cost**: ~$0.30-0.60

**Total estimated cost**: Less than $1/month

## Customization Ideas

- **Multi-post monitoring**: Modify to track multiple posts
- **Sentiment analysis**: Skip comments with negative sentiment
- **Response templates**: Add template responses for common questions
- **Analytics**: Track response rates, engagement metrics
- **Custom triggers**: React to specific keywords or phrases

## Development

### Local Testing

```bash
# Run in development mode
wrangler dev

# Test the manual trigger
curl http://localhost:8787/test
```

### Running Tests

Currently, there are no automated tests. Manual testing recommended:

1. Set all secrets except `REDDIT_POST_ID`
2. Deploy to Cloudflare
3. Test with `/test` endpoint
4. Check logs for errors
5. Set `REDDIT_POST_ID` to a test post
6. Monitor for 1-2 hours
7. Verify replies are posted correctly

## License

Part of the arohaislove.github.io portfolio project.

## Support

For issues or questions:
1. Check the logs first: `wrangler tail perspective-bot`
2. Review this README
3. Check Cloudflare Workers documentation
4. Review Reddit API documentation

---

**Remember**: This bot represents the Perspective Engine's contemplative spirit. Keep responses thoughtful, kind, and appreciative of finite time.
