<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oneiros — Dream Journal</title>

  <!-- Privacy-friendly analytics by Plausible -->
  <script async src="https://plausible.io/js/pa-YDHVJtiLBBWA8IRTBSaq6.js"></script>
  <script>
    window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
    plausible.init()
  </script>
  <script src="/shared/analytics.js"></script>

  <!-- LZString compression library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Instrument+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --ink: #1a1a1a;
      --paper: #f5f2eb;
      --paper-dark: #e8e4d9;
      --accent: #4a5568;
      --gold: #8b7355;
      --phantom: rgba(26, 26, 26, 0.06);
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Instrument Sans', sans-serif;
      background: var(--paper);
      color: var(--ink);
      min-height: 100vh;
      line-height: 1.6;
      position: relative;
      overflow-x: hidden;
    }

    /* Paper texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 1000;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    /* Navigation */
    nav {
      margin-bottom: 2rem;
    }

    nav a {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.9rem;
      color: var(--accent);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    nav a:hover {
      color: var(--gold);
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 4rem;
      padding-bottom: 3rem;
      border-bottom: 1px solid var(--phantom);
    }

    h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 3.5rem;
      font-weight: 300;
      letter-spacing: 0.15em;
      margin-bottom: 0.5rem;
      color: var(--ink);
    }

    .subtitle {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 300;
      font-style: italic;
      color: var(--accent);
      letter-spacing: 0.05em;
    }

    /* Storage Warning */
    .storage-warning {
      display: none;
      background: #fffbeb;
      border: 1px solid #f59e0b;
      border-radius: 2px;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.9rem;
      color: #92400e;
    }

    .storage-warning.visible {
      display: block;
    }

    .storage-warning strong {
      display: block;
      margin-bottom: 0.5rem;
    }

    .storage-bar {
      height: 6px;
      background: #fef3c7;
      border-radius: 3px;
      margin: 0.75rem 0;
      overflow: hidden;
    }

    .storage-bar-fill {
      height: 100%;
      background: #f59e0b;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .storage-bar-fill.critical {
      background: #dc2626;
    }

    /* Entry Form */
    .entry-form {
      background: white;
      border-radius: 2px;
      padding: 2.5rem;
      margin-bottom: 3rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      border: 1px solid var(--phantom);
    }

    .form-section {
      margin-bottom: 2rem;
    }

    .form-section:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 0.75rem;
      color: var(--ink);
    }

    .label-hint {
      font-weight: 300;
      font-style: italic;
      color: var(--accent);
      font-size: 0.95rem;
    }

    /* Upload Area */
    .upload-area {
      border: 2px dashed var(--paper-dark);
      border-radius: 2px;
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .upload-area:hover {
      border-color: var(--gold);
      background: rgba(139, 115, 85, 0.02);
    }

    .upload-area.has-image {
      padding: 1rem;
      border-style: solid;
      border-color: var(--paper-dark);
    }

    .upload-area input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .upload-placeholder {
      color: var(--accent);
    }

    .upload-placeholder svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      stroke: var(--gold);
      stroke-width: 1;
    }

    .upload-placeholder p {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
    }

    .preview-image {
      max-width: 100%;
      max-height: 400px;
      display: none;
      margin: 0 auto;
      border-radius: 2px;
    }

    .preview-image.visible {
      display: block;
    }

    /* Text Input */
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      line-height: 1.7;
      border: 1px solid var(--paper-dark);
      border-radius: 2px;
      background: var(--paper);
      color: var(--ink);
      resize: vertical;
      transition: border-color 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--gold);
    }

    textarea::placeholder {
      color: var(--accent);
      font-style: italic;
    }

    /* Button */
    .submit-btn {
      display: block;
      width: 100%;
      padding: 1rem 2rem;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      color: var(--paper);
      background: var(--ink);
      border: none;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submit-btn:hover:not(:disabled) {
      background: var(--gold);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Loading State */
    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 2rem;
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
      color: var(--accent);
    }

    .loading.visible {
      display: flex;
    }

    /* Error Display */
    .error-display {
      display: none;
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 2px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .error-display.visible {
      display: block;
    }

    .error-title {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #c53030;
      margin-bottom: 1rem;
    }

    .error-message {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      line-height: 1.6;
      color: #742a2a;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .error-details {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.85rem;
      color: #742a2a;
      margin-top: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 2px;
      overflow-x: auto;
    }

    .loading-dot {
      width: 6px;
      height: 6px;
      background: var(--gold);
      border-radius: 50%;
      animation: pulse 1.4s ease-in-out infinite;
    }

    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes pulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    /* Response */
    .response {
      display: none;
      background: white;
      border-radius: 2px;
      padding: 3rem;
      margin-bottom: 3rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      border: 1px solid var(--phantom);
      animation: fadeIn 0.6s ease;
    }

    .response.visible {
      display: block;
    }

    .response-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .response-image-container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .response-image {
      max-width: 100%;
      height: auto;
      border-radius: 2px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .response-text {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .response-date {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 1.5rem;
    }

    .response-poem {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.35rem;
      font-weight: 300;
      line-height: 1.9;
      color: var(--ink);
      white-space: pre-wrap;
    }

    .response-symbols {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--phantom);
    }

    .response-symbols h3 {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 0.75rem;
    }

    .symbols-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .symbol-tag {
      font-family: 'Cormorant Garamond', serif;
      font-size: 0.95rem;
      font-style: italic;
      padding: 0.25rem 0.75rem;
      background: var(--paper);
      border-radius: 2px;
      color: var(--ink);
    }

    /* Archive */
    .archive {
      margin-top: 4rem;
      padding-top: 3rem;
      border-top: 1px solid var(--phantom);
    }

    .archive-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .archive h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 400;
      letter-spacing: 0.05em;
    }

    .archive-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .archive-count {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.8rem;
      color: var(--accent);
    }

    .archive-btn {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.75rem;
      padding: 0.4rem 0.75rem;
      background: var(--paper-dark);
      border: 1px solid var(--phantom);
      border-radius: 2px;
      cursor: pointer;
      color: var(--accent);
      transition: all 0.2s ease;
    }

    .archive-btn:hover {
      background: var(--gold);
      color: white;
      border-color: var(--gold);
    }

    .archive-btn.danger:hover {
      background: #dc2626;
      border-color: #dc2626;
    }

    .archive-empty {
      text-align: center;
      padding: 3rem;
      color: var(--accent);
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
    }

    .archive-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .archive-entry {
      background: white;
      border-radius: 2px;
      padding: 1.5rem;
      border: 1px solid var(--phantom);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .archive-entry:hover {
      border-color: var(--paper-dark);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .archive-entry-date {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .archive-entry-preview {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
      color: var(--ink);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 26, 26, 0.8);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--paper);
      max-width: 700px;
      max-height: 80vh;
      width: 100%;
      border-radius: 2px;
      padding: 3rem;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--accent);
      font-size: 1.5rem;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--ink);
    }

    .modal-image {
      max-width: 100%;
      max-height: 300px;
      display: block;
      margin: 0 auto 2rem;
      border-radius: 2px;
    }

    .modal-poem {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 300;
      line-height: 1.9;
      white-space: pre-wrap;
      margin-bottom: 1.5rem;
    }

    .modal-context {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      font-style: italic;
      color: var(--accent);
      padding-top: 1.5rem;
      border-top: 1px solid var(--phantom);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 2rem 1.25rem;
      }

      h1 {
        font-size: 2.5rem;
      }

      .entry-form,
      .response {
        padding: 1.5rem;
      }

      .response-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .modal {
        padding: 2rem;
      }

      .archive-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <a href="/">← Back to Projects</a>
    </nav>

    <header>
      <h1>Oneiros</h1>
      <p class="subtitle">A journal for the territory between waking and sleep</p>
    </header>

    <div class="storage-warning" id="storageWarning">
      <strong>⚠️ Storage Nearly Full</strong>
      <div class="storage-bar">
        <div class="storage-bar-fill" id="storageBarFill"></div>
      </div>
      <span id="storageText">Consider exporting and clearing old dreams to free up space.</span>
    </div>

    <div class="entry-form">
      <div class="form-section">
        <label>
          The Image
          <span class="label-hint">— a sketch, a photograph, whatever surfaced</span>
        </label>
        <div class="upload-area" id="uploadArea">
          <input type="file" id="imageInput" accept="image/*">
          <div class="upload-placeholder" id="uploadPlaceholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
            </svg>
            <p>Drop an image here, or click to select</p>
          </div>
          <img class="preview-image" id="previewImage" alt="Preview">
        </div>
      </div>

      <div class="form-section">
        <label>
          The Feeling
          <span class="label-hint">— optional fragments, sensations, residue</span>
        </label>
        <textarea id="contextInput" placeholder="What lingered when you woke? A colour, a presence, unease or warmth..."></textarea>
      </div>

      <button class="submit-btn" id="submitBtn" disabled>Divine the Dream</button>
    </div>

    <div class="loading" id="loading">
      <span>Listening</span>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>

    <div class="error-display" id="errorDisplay">
      <div class="error-title">Error</div>
      <div class="error-message" id="errorMessage"></div>
      <div class="error-details" id="errorDetails"></div>
    </div>

    <div class="response" id="response">
      <div class="response-date" id="responseDate"></div>
      <div class="response-content">
        <div class="response-image-container">
          <img class="response-image" id="responseImage" alt="Dream image">
        </div>
        <div class="response-text">
          <div class="response-poem" id="responsePoem"></div>
        </div>
      </div>
      <div class="response-symbols">
        <h3>Recurring Symbols</h3>
        <div class="symbols-list" id="symbolsList"></div>
      </div>
    </div>

    <div class="archive" id="archive">
      <div class="archive-header">
        <h2>Archive</h2>
        <div class="archive-actions">
          <span class="archive-count" id="archiveCount"></span>
          <button class="archive-btn" id="exportBtn" title="Export dreams as JSON">Export</button>
          <button class="archive-btn" id="importBtn" title="Import dreams from JSON">Import</button>
          <button class="archive-btn danger" id="clearBtn" title="Clear all dreams">Clear All</button>
        </div>
      </div>
      <div class="archive-list" id="archiveList">
        <div class="archive-empty">No dreams recorded yet</div>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="importInput" accept=".json" style="display: none;">

  <!-- Modal for viewing entries -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <button class="modal-close" id="modalClose">&times;</button>
      <img class="modal-image" id="modalImage" alt="Dream sketch">
      <div class="response-date" id="modalDate"></div>
      <div class="modal-poem" id="modalPoem"></div>
      <div class="modal-context" id="modalContext"></div>
    </div>
  </div>


  <script>
    // ===========================================
    // STORAGE MANAGEMENT
    // ===========================================
    
    const STORAGE_KEY = 'oneiros_entries';
    const MAX_IMAGE_WIDTH = 800;  // Compress images to this max width
    const MAX_IMAGE_QUALITY = 0.7; // JPEG quality
    const STORAGE_WARNING_THRESHOLD = 0.75; // Warn at 75% full
    const MAX_ENTRIES = 100; // Keep max 100 entries
    
    // Storage helper with compression
    const Storage = {
      save(entries) {
        try {
          const json = JSON.stringify(entries);
          const compressed = LZString.compressToUTF16(json);
          localStorage.setItem(STORAGE_KEY, compressed);
          this.checkQuota();
          return true;
        } catch (e) {
          if (e.name === 'QuotaExceededError') {
            showError('Storage Full', 
              'Your dream journal is full. Please export your dreams and clear some entries to continue.',
              'You can use the Export button to save your dreams, then Clear All to free up space.');
            return false;
          }
          console.error('Storage error:', e);
          return false;
        }
      },
      
      load() {
        try {
          const compressed = localStorage.getItem(STORAGE_KEY);
          if (!compressed) return [];
          
          // Try to decompress (new format)
          const decompressed = LZString.decompressFromUTF16(compressed);
          if (decompressed) {
            return JSON.parse(decompressed);
          }
          
          // Fall back to old uncompressed format
          return JSON.parse(compressed);
        } catch (e) {
          console.error('Error loading entries:', e);
          // Try raw parse as fallback
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return JSON.parse(raw) || [];
          } catch {
            return [];
          }
        }
      },
      
      getUsage() {
        let total = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            total += localStorage.getItem(key).length * 2; // UTF-16 = 2 bytes per char
          }
        }
        return total;
      },
      
      getQuotaPercent() {
        // localStorage typically has 5MB limit
        const used = this.getUsage();
        const limit = 5 * 1024 * 1024; // 5MB
        return used / limit;
      },
      
      checkQuota() {
        const percent = this.getQuotaPercent();
        const warning = document.getElementById('storageWarning');
        const fill = document.getElementById('storageBarFill');
        const text = document.getElementById('storageText');
        
        if (percent > STORAGE_WARNING_THRESHOLD) {
          warning.classList.add('visible');
          fill.style.width = (percent * 100) + '%';
          
          if (percent > 0.9) {
            fill.classList.add('critical');
            text.textContent = `Storage is ${Math.round(percent * 100)}% full! Export and clear dreams immediately.`;
          } else {
            fill.classList.remove('critical');
            text.textContent = `Storage is ${Math.round(percent * 100)}% full. Consider exporting and clearing old dreams.`;
          }
        } else {
          warning.classList.remove('visible');
        }
      },
      
      migrateOldData() {
        // Check if we have old uncompressed data and migrate it
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          
          // If it starts with '[', it's likely old JSON format
          if (raw.startsWith('[')) {
            console.log('Migrating old uncompressed data...');
            const entries = JSON.parse(raw);
            this.save(entries);
            console.log('Migration complete');
          }
        } catch (e) {
          console.error('Migration error:', e);
        }
      }
    };

    // ===========================================
    // IMAGE COMPRESSION
    // ===========================================
    
    function compressImage(dataUrl, maxWidth = MAX_IMAGE_WIDTH, quality = MAX_IMAGE_QUALITY) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          let { width, height } = img;
          
          // Calculate new dimensions
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          
          // Create canvas and draw
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // Export as JPEG for better compression
          const compressed = canvas.toDataURL('image/jpeg', quality);
          resolve(compressed);
        };
        img.src = dataUrl;
      });
    }

    // ===========================================
    // STATE
    // ===========================================
    
    let currentImage = null;
    let currentImageData = null;
    let entries = [];

    // Hardcoded API endpoint (worker with baked-in API key)
    const PROXY_URL = 'https://cors-proxy.zammel.workers.dev/anthropic';

    // ===========================================
    // ELEMENTS
    // ===========================================
    
    const imageInput = document.getElementById('imageInput');
    const uploadArea = document.getElementById('uploadArea');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const previewImage = document.getElementById('previewImage');
    const contextInput = document.getElementById('contextInput');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const errorDisplay = document.getElementById('errorDisplay');
    const errorMessage = document.getElementById('errorMessage');
    const errorDetails = document.getElementById('errorDetails');
    const response = document.getElementById('response');
    const responseDate = document.getElementById('responseDate');
    const responseImage = document.getElementById('responseImage');
    const responsePoem = document.getElementById('responsePoem');
    const symbolsList = document.getElementById('symbolsList');
    const archiveList = document.getElementById('archiveList');
    const archiveCount = document.getElementById('archiveCount');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const modalImage = document.getElementById('modalImage');
    const modalDate = document.getElementById('modalDate');
    const modalPoem = document.getElementById('modalPoem');
    const modalContext = document.getElementById('modalContext');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importInput = document.getElementById('importInput');
    const clearBtn = document.getElementById('clearBtn');

    // ===========================================
    // IMAGE HANDLING
    // ===========================================
    
    imageInput.addEventListener('change', handleImageSelect);

    async function handleImageSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        // Compress the image before storing
        const originalData = e.target.result;
        currentImageData = await compressImage(originalData);
        
        previewImage.src = currentImageData;
        previewImage.classList.add('visible');
        uploadPlaceholder.style.display = 'none';
        uploadArea.classList.add('has-image');
        submitBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    // ===========================================
    // ERROR HANDLING
    // ===========================================
    
    function showError(title, message, details = '') {
      errorMessage.textContent = message;
      errorDetails.textContent = details;
      errorDetails.style.display = details ? 'block' : 'none';
      errorDisplay.classList.add('visible');
      console.error('Error:', title, message, details);
    }

    function hideError() {
      errorDisplay.classList.remove('visible');
    }

    // ===========================================
    // SUBMIT DREAM
    // ===========================================
    
    async function submitDream() {
      if (!currentImageData) {
        showError('No Image', 'Please upload an image of your dream first');
        return;
      }

      hideError();
      submitBtn.disabled = true;
      loading.classList.add('visible');
      response.classList.remove('visible');

      try {
        console.log('Submitting dream to:', PROXY_URL);
        const context = contextInput.value.trim();
        const base64Data = currentImageData.split(',')[1];
        const mediaType = currentImageData.split(';')[0].split(':')[1];

        const systemPrompt = `You are Oneiros, a poetic interpreter of dreams. You receive images of dream sketches or photographs along with optional context about feelings or fragments the dreamer remembers.

Your role is to respond with:
1. A poem (free verse, 8-20 lines) that doesn't describe the image literally but responds to its emotional and symbolic resonance. The poem should feel like it emerged from the same territory as the dream—liminal, surprising, true in the way dreams are true.
2. A list of 3-5 archetypal symbols or themes you perceive (single words or short phrases).

Format your response exactly like this:
[POEM]
Your poem here
line by line

[SYMBOLS]
symbol one, symbol two, symbol three

Be evocative, not diagnostic. You are not analyzing—you are dreaming alongside.`;

        const userContent = [
          {
            type: "image",
            source: {
              type: "base64",
              media_type: mediaType,
              data: base64Data
            }
          },
          {
            type: "text",
            text: context
              ? `The dreamer shares this feeling: "${context}"\n\nRespond to this dream image.`
              : "Respond to this dream image."
          }
        ];

        const requestBody = {
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 1024,
          system: systemPrompt,
          messages: [{
            role: 'user',
            content: userContent
          }]
        };

        console.log('Making API request...');
        const apiResponse = await fetch(PROXY_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify(requestBody)
        });

        console.log('Response status:', apiResponse.status, apiResponse.statusText);

        if (!apiResponse.ok) {
          const errorText = await apiResponse.text();
          console.error('API error response:', errorText);

          let errorMsg = 'The API request failed.';
          if (apiResponse.status === 500) {
            errorMsg = 'Server error. The worker may not be configured correctly.';
          } else if (apiResponse.status === 401) {
            errorMsg = 'Authentication failed. API key may be missing or invalid.';
          } else if (apiResponse.status === 429) {
            errorMsg = 'Rate limit exceeded. Please try again in a moment.';
          }

          throw new Error(errorMsg + '\n\nStatus: ' + apiResponse.status + '\nDetails: ' + errorText);
        }

        const data = await apiResponse.json();
        console.log('Received response from API');

        if (data.error) {
          console.error('API error:', data.error);
          throw new Error(data.error.message || 'API error: ' + JSON.stringify(data.error));
        }

        const responseText = data.content[0].text;

        // Parse response
        const poemMatch = responseText.match(/\[POEM\]\s*([\s\S]*?)\s*\[SYMBOLS\]/);
        const symbolsMatch = responseText.match(/\[SYMBOLS\]\s*([\s\S]*?)$/);

        const poem = poemMatch ? poemMatch[1].trim() : responseText;
        const symbols = symbolsMatch
          ? symbolsMatch[1].split(',').map(s => s.trim()).filter(s => s)
          : [];

        // Display
        const now = new Date();
        responseDate.textContent = formatDate(now);
        responseImage.src = currentImageData;
        responsePoem.textContent = poem;

        symbolsList.innerHTML = symbols.map(s =>
          `<span class="symbol-tag">${s}</span>`
        ).join('');

        response.classList.add('visible');

        // Save entry
        const entry = {
          id: Date.now(),
          date: now.toISOString(),
          image: currentImageData,
          context: context,
          poem: poem,
          symbols: symbols
        };

        entries.unshift(entry);
        
        // Limit entries to prevent unbounded growth
        if (entries.length > MAX_ENTRIES) {
          entries = entries.slice(0, MAX_ENTRIES);
        }
        
        if (!Storage.save(entries)) {
          // Storage failed, but we still have the entry in memory
          console.warn('Failed to save to localStorage');
        }
        
        renderArchive();

        // Reset form after successful submission
        currentImageData = null;
        previewImage.src = '';
        previewImage.classList.remove('visible');
        uploadPlaceholder.style.display = 'block';
        uploadArea.classList.remove('has-image');
        contextInput.value = '';
        imageInput.value = '';
        submitBtn.disabled = true;

      } catch (error) {
        console.error('Error:', error);

        const errorParts = error.message.split('\n\n');
        const mainMessage = errorParts[0] || 'Failed to divine the dream';
        const details = errorParts.slice(1).join('\n\n') || error.stack || 'No additional details';

        showError('Dream Divination Failed', mainMessage, details);
        submitBtn.disabled = false;
      } finally {
        loading.classList.remove('visible');
      }
    }

    submitBtn.addEventListener('click', submitDream);

    // ===========================================
    // ARCHIVE
    // ===========================================
    
    function renderArchive() {
      archiveCount.textContent = `${entries.length} ${entries.length === 1 ? 'dream' : 'dreams'}`;

      if (entries.length === 0) {
        archiveList.innerHTML = '<div class="archive-empty">No dreams recorded yet</div>';
        return;
      }

      archiveList.innerHTML = entries.map(entry => `
        <div class="archive-entry" data-id="${entry.id}">
          <div class="archive-entry-date">${formatDate(new Date(entry.date))}</div>
          <div class="archive-entry-preview">${entry.poem.split('\n')[0]}</div>
        </div>
      `).join('');

      document.querySelectorAll('.archive-entry').forEach(el => {
        el.addEventListener('click', () => {
          const entry = entries.find(e => e.id === parseInt(el.dataset.id));
          if (entry) showModal(entry);
        });
      });
    }

    function showModal(entry) {
      modalImage.src = entry.image;
      modalDate.textContent = formatDate(new Date(entry.date));
      modalPoem.textContent = entry.poem;
      modalContext.textContent = entry.context || 'No context recorded';
      modalOverlay.classList.add('visible');
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-NZ', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // ===========================================
    // EXPORT / IMPORT / CLEAR
    // ===========================================
    
    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(entries, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `oneiros-dreams-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => {
      importInput.click();
    });

    importInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const imported = JSON.parse(text);
        
        if (!Array.isArray(imported)) {
          throw new Error('Invalid format');
        }

        // Merge with existing, avoiding duplicates by ID
        const existingIds = new Set(entries.map(e => e.id));
        const newEntries = imported.filter(e => !existingIds.has(e.id));
        
        entries = [...newEntries, ...entries].sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        );
        
        if (entries.length > MAX_ENTRIES) {
          entries = entries.slice(0, MAX_ENTRIES);
        }

        Storage.save(entries);
        renderArchive();
        
        alert(`Imported ${newEntries.length} new dreams.`);
      } catch (err) {
        showError('Import Failed', 'Could not read the file. Make sure it\'s a valid Oneiros export.');
      }
      
      importInput.value = '';
    });

    clearBtn.addEventListener('click', () => {
      if (entries.length === 0) {
        alert('No dreams to clear.');
        return;
      }
      
      const confirmed = confirm(
        `Are you sure you want to delete all ${entries.length} dreams?\n\n` +
        `This cannot be undone. Consider exporting first.`
      );
      
      if (confirmed) {
        entries = [];
        localStorage.removeItem(STORAGE_KEY);
        Storage.checkQuota();
        renderArchive();
      }
    });

    // ===========================================
    // MODAL
    // ===========================================
    
    modalClose.addEventListener('click', () => {
      modalOverlay.classList.remove('visible');
    });

    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.classList.remove('visible');
      }
    });

    // ===========================================
    // INITIALIZE
    // ===========================================
    
    // Migrate old data if needed
    Storage.migrateOldData();
    
    // Load entries
    entries = Storage.load();
    
    // Check storage quota
    Storage.checkQuota();
    
    // Render archive
    renderArchive();

    // Initialize analytics
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (window.Analytics) {
          Analytics.init();
        }
      });
    } else {
      if (window.Analytics) {
        Analytics.init();
      }
    }
  </script>
</body>
</html>
